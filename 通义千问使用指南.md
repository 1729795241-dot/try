# 🤖 通义千问版本使用指南

## 📖 目录

1. [快速开始](#快速开始)
2. [获取API密钥](#获取api密钥)
3. [使用Web应用](#使用web应用)
4. [使用Python代码](#使用python代码)
5. [高级功能](#高级功能)
6. [常见问题](#常见问题)
7. [最佳实践](#最佳实践)

---

## 🚀 快速开始

### 1. 获取通义千问API密钥

访问：**https://dashscope.console.aliyun.com/**

1. 登录阿里云账号（没有账号需要先注册）
2. 开通"模型服务灵积"（DashScope）服务
3. 点击"API-KEY管理"
4. 创建新的API Key
5. 复制API密钥（格式：`sk-xxxxxxxxxxxxxxxx`）

**免费额度：**
- 新用户赠送100万Token
- 有效期90天
- 足够处理约50份财务报表

### 2. 配置API密钥

**方法1：环境变量（推荐）**

编辑 `.env` 文件：
```
DASHSCOPE_API_KEY=sk-your_api_key_here
```

**方法2：Web界面输入**

在侧边栏的"通义千问API密钥"输入框中输入

### 3. 启动应用

**Windows:**
```bash
双击 start_qwen.bat
```

**或使用命令行:**
```bash
streamlit run app_qwen.py
```

### 4. 上传PDF并分析

1. 在浏览器中打开 http://localhost:8501
2. 点击"选择PDF文件"上传财务报表
3. 点击"开始分析"
4. 等待1-2分钟
5. 查看结果并下载文件

---

## 🔑 获取API密钥

### 详细步骤

#### 步骤1：注册阿里云账号

1. 访问 https://www.aliyun.com/
2. 点击"免费注册"
3. 填写手机号、验证码等信息
4. 完成实名认证（需要身份证）

#### 步骤2：开通DashScope服务

1. 访问 https://dashscope.console.aliyun.com/
2. 首次访问会提示开通服务
3. 点击"立即开通"
4. 阅读并同意服务协议
5. 开通成功

#### 步骤3：创建API Key

1. 在DashScope控制台，点击左侧"API-KEY管理"
2. 点击"创建新的API-KEY"
3. 输入密钥名称（如：财务分析系统）
4. 点击"确定"
5. **立即复制并保存API Key**（只显示一次！）

#### 步骤4：查看免费额度

1. 在控制台点击"资源包管理"
2. 查看"通义千问-Long"的免费额度
3. 默认100万Token，90天有效期

---

## 💻 使用Web应用

### 界面说明

#### 侧边栏
- **API密钥设置** - 输入通义千问API密钥
- **输出目录** - 设置结果保存位置
- **使用说明** - 快速参考
- **系统信息** - 版本和模型信息

#### 主界面标签页

**1. 上传分析**
- 上传PDF文件（最大150MB）
- 查看文件信息
- 开始分析
- 查看分析摘要

**2. 查看结果**
- 完整财务数据
- AI分析报告
- 可视化图表
- 下载文件

**3. 历史记录**
- 查看历史分析
- 重新查看旧报告
- 删除历史记录

### 操作流程

```
上传PDF → 输入API密钥 → 开始分析 → 等待处理 → 查看结果 → 下载文件
```

---

## 🐍 使用Python代码

### 基础用法

```python
from src.qwen_workflow import QwenFinancialWorkflow

# 创建工作流
workflow = QwenFinancialWorkflow(
    api_key="sk-your_api_key_here",
    output_dir="output_qwen"
)

# 分析单个PDF
result = workflow.run("财务报表.pdf")

# 查看结果
print(f"公司: {result['financial_data']['company_info']['name']}")
print(f"Excel: {result['files']['excel']}")
print(f"报告: {result['files']['report']}")
```

### 批量处理

```python
from src.qwen_workflow import QwenFinancialWorkflow

workflow = QwenFinancialWorkflow(api_key="your_key")

# 批量处理多个PDF
pdf_files = [
    "公司A_2023年报.pdf",
    "公司B_2023年报.pdf",
    "公司C_2023年报.pdf"
]

results = workflow.run_batch(pdf_files)

# 查看结果
for i, result in enumerate(results):
    if 'error' not in result:
        print(f"✓ {pdf_files[i]} 处理成功")
    else:
        print(f"✗ {pdf_files[i]} 处理失败: {result['error']}")
```

### 自定义问答

```python
from src.qwen_client import QwenClient

client = QwenClient(api_key="your_key")

# 对PDF提出自定义问题
questions = [
    "公司的主营业务是什么？",
    "2023年的营业收入是多少？",
    "公司面临的主要风险有哪些？",
    "研发投入占营收的比例是多少？"
]

answers = client.analyze_pdf_with_questions("年报.pdf", questions)

for q, a in answers.items():
    print(f"Q: {q}")
    print(f"A: {a}\n")
```

---

## 🎯 高级功能

### 1. 超长文档处理

通义千问支持1000万Token上下文，可以处理几百页的完整年报：

```python
workflow = QwenFinancialWorkflow(api_key="your_key")

# 处理500页的年报
result = workflow.run("超长年报_500页.pdf")
```

**优势：**
- ✅ 无需分块处理
- ✅ 保持完整上下文
- ✅ 更准确的分析

### 2. 多格式支持

除了PDF，还支持其他格式：

```python
from src.qwen_client import QwenClient

client = QwenClient(api_key="your_key")

# 上传DOCX文件
file_id = client.upload_pdf("财报.docx")  # 方法名虽然是upload_pdf，但支持多种格式

# 提取信息
info = client.extract_financial_info_from_pdf("财报.docx")
```

**支持的格式：**
- PDF
- DOCX
- TXT
- XLSX
- EPUB
- MD
- CSV
- JSON

### 3. 自定义提示词

```python
from src.qwen_client import QwenClient

client = QwenClient(api_key="your_key")

# 上传PDF
file_id = client.upload_pdf("年报.pdf")

# 自定义分析
custom_prompt = """
请分析这份财报，重点关注：
1. 研发投入情况
2. 海外市场拓展
3. 数字化转型进展
4. ESG（环境、社会、治理）表现
"""

completion = client.client.chat.completions.create(
    model="qwen-long",
    messages=[
        {'role': 'system', 'content': 'You are a financial analyst.'},
        {'role': 'system', 'content': f'fileid://{file_id}'},
        {'role': 'user', 'content': custom_prompt}
    ]
)

print(completion.choices[0].message.content)
```

---

## ❓ 常见问题

### Q1: 如何获取免费额度？

**A:** 新用户开通DashScope服务后自动获得100万Token免费额度，有效期90天。

### Q2: 免费额度用完后怎么办？

**A:** 可以充值使用，价格：
- 输入：¥0.0005/千Token
- 输出：¥0.002/千Token
- 处理50页PDF约¥0.02

### Q3: 支持扫描版PDF吗？

**A:** ✅ 完全支持！通义千问内置OCR能力，可以识别扫描版PDF中的文字和表格。

### Q4: 文件大小限制是多少？

**A:** PDF文件最大150MB，图片最大20MB。

### Q5: 处理一份报表需要多长时间？

**A:** 
- 50页PDF：约60秒
- 100页PDF：约120秒
- 500页PDF：约5-10分钟

### Q6: 如何查看API使用量？

**A:** 
1. 登录 https://dashscope.console.aliyun.com/
2. 点击"资源包管理"
3. 查看"通义千问-Long"的使用情况

### Q7: API密钥泄露了怎么办？

**A:**
1. 立即登录DashScope控制台
2. 删除泄露的API Key
3. 创建新的API Key
4. 更新系统配置

---

## 💡 最佳实践

### 1. 文件准备

**推荐：**
- ✅ 使用文本型PDF（处理更快）
- ✅ 文件大小控制在50MB以内
- ✅ 确保PDF可以正常打开

**避免：**
- ❌ 加密的PDF
- ❌ 损坏的PDF
- ❌ 纯图片PDF（虽然支持，但成本更高）

### 2. API密钥管理

**推荐：**
- ✅ 使用环境变量存储密钥
- ✅ 不要将密钥提交到Git
- ✅ 定期更换密钥
- ✅ 为不同项目使用不同密钥

**避免：**
- ❌ 在代码中硬编码密钥
- ❌ 在公开场合分享密钥
- ❌ 使用同一密钥用于所有项目

### 3. 成本优化

**策略：**
1. **文本型PDF优先用DeepSeek**（更便宜）
2. **扫描版PDF用通义千问**（必须）
3. **批量处理时合理安排**（避免超时）
4. **充分利用免费额度**（100万Token）

**示例：**
```python
def smart_analyze(pdf_path):
    """智能选择AI引擎"""
    if is_text_pdf(pdf_path):
        # 文本型用DeepSeek（¥0.001/份）
        from src.workflow import FinancialWorkflow
        workflow = FinancialWorkflow(api_key="deepseek_key")
    else:
        # 扫描版用通义千问（¥0.02/份）
        from src.qwen_workflow import QwenFinancialWorkflow
        workflow = QwenFinancialWorkflow(api_key="qwen_key")
    
    return workflow.run(pdf_path)
```

### 4. 错误处理

```python
from src.qwen_workflow import QwenFinancialWorkflow
import time

def robust_analyze(pdf_path, max_retries=3):
    """带重试的分析"""
    workflow = QwenFinancialWorkflow(api_key="your_key")
    
    for attempt in range(max_retries):
        try:
            result = workflow.run(pdf_path)
            return result
        except Exception as e:
            print(f"尝试 {attempt + 1} 失败: {str(e)}")
            if attempt < max_retries - 1:
                time.sleep(5)  # 等待5秒后重试
            else:
                raise
```

---

## 📞 获取帮助

- 📖 [三大AI引擎对比](三大AI引擎对比.md)
- 📖 [常见问题解答](常见问题解答.md)
- 🌐 [通义千问官方文档](https://help.aliyun.com/zh/dashscope/)
- 🌐 [DashScope控制台](https://dashscope.console.aliyun.com/)

---

**最后更新：2025-10-28**  
**版本：3.0.0**  
**Powered by 阿里云通义千问 Qwen-Long** 🤖

